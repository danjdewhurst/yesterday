#!/usr/bin/env bash
set -eo pipefail

show_help() {
    cat << 'EOF'
yesterday - List git commits from yesterday and today for standups

Usage: yesterday [options] [-- git-log-options]

Options:
  -a, --all-authors    Show commits from all authors (default: current user)
  -t, --all-time       Show all commits (default: since yesterday)
  -l, --literal        Use literal yesterday (default: last Friday on Mondays)
  -h, --help           Show this help message

Examples:
  yesterday                      Your commits from yesterday + today
  yesterday -a                   All authors' commits
  yesterday -t                   Your commits from all time
  yesterday -at                  All commits from all authors
  yesterday --since="1 week ago" Custom time range (passes to git log)

Output: hash  datetime  author  message
EOF
    exit 0
}

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
    echo "Error: Not a git repository" >&2
    exit 1
fi

# Get the current git user's name for default filtering
GIT_USER=$(git config user.name 2>/dev/null || echo "")

# Check for flags
SHOW_ALL=false
SHOW_ALL_TIME=false
LITERAL_YESTERDAY=false
PASS_ARGS=()
for arg in "$@"; do
    case "$arg" in
        --help|-h|-H)
            show_help
            ;;
        --all-authors|-a|-A)
            SHOW_ALL=true
            ;;
        --all-time|-t|-T)
            SHOW_ALL_TIME=true
            ;;
        --literal|-l|-L)
            LITERAL_YESTERDAY=true
            ;;
        -[aAtTlL][aAtTlL]|-[aAtTlL][aAtTlL][aAtTlL])
            # Combined short flags like -at, -al, -atl, etc.
            [[ "$arg" =~ [aA] ]] && SHOW_ALL=true
            [[ "$arg" =~ [tT] ]] && SHOW_ALL_TIME=true
            [[ "$arg" =~ [lL] ]] && LITERAL_YESTERDAY=true
            ;;
        *)
            PASS_ARGS+=("$arg")
            ;;
    esac
done

# Build git log command (use commit date %cd to match --since filtering)
GIT_CMD=(git log --all --format="%h|%cd|%an|%s" --date=format:"%Y-%m-%d %H:%M")

# Add author filter (default to current user unless --all-authors/-a or custom --author)
if [[ "$SHOW_ALL" == false ]] && [[ -n "$GIT_USER" ]] && [[ ! " $* " =~ "--author" ]]; then
    GIT_CMD+=("--author=$GIT_USER")
fi

# Add time filter (default to since start of yesterday unless --all-time/-t or custom --since/--after)
# On Mondays, default to "last friday" instead of "yesterday" (unless --literal/-l)
if [[ "$SHOW_ALL_TIME" == false ]] && [[ ! " $* " =~ "--since" ]] && [[ ! " $* " =~ "--after" ]]; then
    if [[ "$LITERAL_YESTERDAY" == true ]] || [[ $(date +%u) -ne 1 ]]; then
        GIT_CMD+=("--since=yesterday")
    else
        GIT_CMD+=("--since=last friday")
    fi
fi

# Add any additional arguments
if [[ ${#PASS_ARGS[@]} -gt 0 ]]; then
    GIT_CMD+=("${PASS_ARGS[@]}")
fi

# Format: short hash | datetime | author | subject
# De-duplicate based on the subject (commit message), dynamic author width
"${GIT_CMD[@]}" | \
    awk -F'|' '
        !seen[$4]++ {
            lines[++n] = $0
            if (length($3) > max) max = length($3)
        }
        END {
            for (i = 1; i <= n; i++) {
                split(lines[i], f, "|")
                printf "%s  %s  %-*s  %s\n", f[1], f[2], max, f[3], f[4]
            }
        }
    '
